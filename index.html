<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="expires" content="0">
    <title>html2Canvas demo</title>
    <style>
        *{margin: 0;padding: 0; box-sizing: border-box;}
        .share-content{
            width: 60vw;
            border: 1px solid blue;
            box-sizing: border-box;
            overflow: hidden;
        }
        .share-content img{
            width: 100%;
        }
    </style>
</head>

<body>
    <div class="share-content" id="shareContent">
        <div class="text">
            <code>英国首都伦敦西部一栋公寓楼14日凌晨突发大火，火灾死亡人数可能在60人以上，一些家庭全家遇难。伦敦警方正就此展开调查。
英国首相在15日视察现场只接见消防员和警员却没有慰问民众的做法激起民愤。16日晚间，伦敦市民将到威斯敏斯特议会大厦前举
行抗议活动。（央视记者 孔琳琳）</code>
            <img src="http://p4.qhimg.com/t01ade62f61406d0061.webp" alt="">
            <p style="padding: 20px;">英国首都伦敦西部一栋公寓楼14日凌晨突发大火，火灾死亡人数可能在60人以上，一些家庭全家遇难。伦敦警方正就此展开调查。
英国首相在15日视察现场只接见消防员和警员却没有慰问民众的做法激起民愤。16日晚间，伦敦市民将到威斯敏斯特议会大厦前举
行抗议活动。（央视记者 孔琳琳）</p>
        </div>
    </div>
    <button class="btn-share" id="btnShare">截&nbsp;图</button>

    <script src="./images_files/html2canvas.js"></script>
    <script>
        var main = {
            init: function () {
                main.setListener();
            },
            //设置监听事件
            setListener: function () {
                var btnShare = document.getElementById("btnShare");
                btnShare.onclick = function () {
                    main.htmlToCanvas(document.querySelector("#shareContent"));
                }
            },
            //获取像素密度
            getPixelRatio: function (context) {
                var backingStore = context.backingStorePixelRatio ||
                    context.webkitBackingStorePixelRatio ||
                    context.mozBackingStorePixelRatio ||
                    context.msBackingStorePixelRatio ||
                    context.oBackingStorePixelRatio ||
                    context.backingStorePixelRatio || 1;
                return (window.devicePixelRatio || 1) / backingStore;
            },
            //绘制dom 元素，生成截图canvas
            htmlToCanvas: function (dom) {
                var shareContent = dom;// 需要绘制的部分的 (原生）dom 对象 ，注意容器的宽度不要使用百分比，使用固定宽度，避免缩放问题
                var width = shareContent.offsetWidth;  // 获取(原生）dom 宽度
                var height = shareContent.offsetHeight; // 获取(原生）dom 高
                var offsetTop = shareContent.offsetTop;  //元素距离顶部的偏移量

                var canvas = document.createElement('canvas');  //创建canvas 对象
                var context = canvas.getContext('2d');
                var scaleBy = main.getPixelRatio(context);  //获取像素密度的方法 (也可以采用自定义缩放比例)
                console.log(scaleBy)
                canvas.width = width * scaleBy;   //这里 由于绘制的dom 为固定宽度，居中，所以没有偏移
                canvas.height = (height + offsetTop) * scaleBy;  // 注意高度问题，由于顶部有个距离所以要加上顶部的距离，解决图像高度偏移问题
                context.scale(scaleBy, scaleBy);

                var opts = {
                    allowTaint: true,//允许加载跨域的图片
                    tainttest: true, //检测每张图片都已经加载完成
                    scale: scaleBy, // 添加的scale 参数
                    canvas: canvas, //自定义 canvas
                    logging: true, //日志开关，发布的时候记得改成false
                    width: width, //dom 原始宽度
                    height: height //dom 原始高度
                };
                html2canvas(shareContent, opts).then(function (canvas) {
                    var body = document.getElementsByTagName("body");
                    body[0].appendChild(canvas);
                });
            }
        };

        //最后运行代码
        main.init();

    </script>
</body>

</html>