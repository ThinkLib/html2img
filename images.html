<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

	<title>images</title>
	<!-- html2canvas就是这样一款前端插件,它的原理是将Dom节点在Canvas里边画出来 -->
	<script src="./images_files/html2canvas.js"></script>

	<!-- 将canvas图片保存成图片 -->
	<script src="./images_files/canvas2image.js"></script>
	<script src="./images_files/base64.js"></script>
	<style>
		body{
			font-family: 'Microsoft Yahei';
		}
		.text-center{
			text-align: center;
		}
		#content {
			padding: 20px;
			border-radius: 3px;
			width:550px;
			border:1px gray solid;
			overflow: hidden;
		}
		h2,p {
			padding: 15px 0;
		}
		img {
			width: 100%;
			margin: 20px 0;
		}
		input,button {
			padding: 5px 10px;
			border: 1px solid #eee;
		}
		*{
			margin: 0;
			padding: 0;
		}
		#btnSave,
		#Download {
			margin: 10px 0 10px 26px;
		}
	</style>
</head>

<body>
	<div id="content" >
		<h2 class="text-center">jczzq</h2>
		<p class="text-center">my htmlToCanvas demo</p>
		<img src="/images_files/t01ade62f61406d0061.jpg" alt="">
		<p>Hello world</p>
		<p>注意：<br>
			1.内含跨域图片不支持下载；<br>
			2.
		</p>
		<p>注意：内含跨域图片不支持下载</p>
		<input type="text" >
		<input type="button" value="提交" onclick="main.setListener">
	</div>
	<button id="btnSave" onclick="main.setListener()">转换成图片</button>
	<div id="images">

	</div>
	<button id="Download">Download</button>

	<script>
		var main = {
            //设置监听事件
            setListener: function () {
                main.htmlToCanvas(document.querySelector('#content'));
            },
            //获取像素密度
            getPixelRatio: function (context) {
                var backingStore = context.backingStorePixelRatio ||
                    context.webkitBackingStorePixelRatio ||
                    context.mozBackingStorePixelRatio ||
                    context.msBackingStorePixelRatio ||
                    context.oBackingStorePixelRatio ||
                    context.backingStorePixelRatio || 1;
                return (window.devicePixelRatio || 1) / backingStore;
            },
            //绘制dom 元素，生成截图canvas
            htmlToCanvas: function (dom) {
                var shareContent = dom;// 需要绘制的部分的 (原生）dom 对象 ，注意容器的宽度不要使用百分比，使用固定宽度，避免缩放问题
                var width = shareContent.offsetWidth;  // 获取(原生）dom 宽度
                var height = shareContent.offsetHeight; // 获取(原生）dom 高
                var offsetTop = shareContent.offsetTop;  //元素距离顶部的偏移量

                var canvas = document.createElement('canvas');  //创建canvas 对象
                var context = canvas.getContext('2d');
                var scaleBy = main.getPixelRatio(context);  //获取像素密度的方法 (也可以采用自定义缩放比例)
                console.log(scaleBy)
                canvas.width = width * scaleBy;   //这里 由于绘制的dom 为固定宽度，居中，所以没有偏移
                canvas.height = (height + offsetTop) * scaleBy;  // 注意高度问题，由于顶部有个距离所以要加上顶部的距离，解决图像高度偏移问题
                context.scale(scaleBy, scaleBy);

                var opts = {
                    allowTaint: true,//允许加载跨域的图片
                    tainttest: true, //检测每张图片都已经加载完成
                    scale: scaleBy, // 添加的scale 参数
                    canvas: canvas, //自定义 canvas
                    logging: false, //日志开关，发布的时候记得改成false
                    width: width, //dom 原始宽度
                    height: height //dom 原始高度
                };
                html2canvas(shareContent, opts).then(function (canvas) {
					canvas.setAttribute('id', 'thecanvas');
                    document.getElementById('images').appendChild(canvas);
                });
            }
        };
	</script>
	<script>
		var Download = document.getElementById('Download');
		Download.onclick = function () {
			var oCanvas = document.getElementById('thecanvas');

			/*自动保存为png*/
			// 获取图片资源
			var img_data1 = Canvas2Image.saveAsPNG(oCanvas, true).getAttribute('src');
			saveFile(img_data1, 'abc');


			/*下面的为原生的保存，不带格式名*/
			// 这将会提示用户保存PNG图片
			// Canvas2Image.saveAsPNG(oCanvas);
		}
		// 保存文件函数
		var saveFile = function (data, filename) {
			var save_link = document.createElementNS('http://www.w3.org/1999/xhtml', 'a');
			save_link.href = data;
			save_link.download = filename;

			var event = document.createEvent('MouseEvents');
			event.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
			save_link.dispatchEvent(event);
		};
	</script>
</body>

</html>